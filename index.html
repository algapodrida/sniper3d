<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>PHANTOM SHOT</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { background:#000; overflow:hidden; font-family:'Courier New',monospace; }
canvas { display:block; }

/* â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#hud { position:fixed; inset:0; pointer-events:none; z-index:10; }

/* Health bar */
#health-wrap {
  position:absolute; top:20px; left:20px; width:180px;
}
#health-label { color:#ff4444; font-size:10px; letter-spacing:3px; margin-bottom:4px; }
#health-bar { width:100%; height:10px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,68,68,0.3); }
#health-fill { height:100%; width:100%; background:linear-gradient(90deg,#ff2222,#ff6644); transition:width 0.2s; }
#health-num { color:#ff4444; font-size:11px; letter-spacing:2px; margin-top:3px; }

/* Armor bar */
#armor-wrap { position:absolute; top:58px; left:20px; width:180px; }
#armor-label { color:#44aaff; font-size:10px; letter-spacing:3px; margin-bottom:4px; }
#armor-bar { width:100%; height:6px; background:rgba(255,255,255,0.1); border:1px solid rgba(68,170,255,0.3); }
#armor-fill { height:100%; width:0%; background:linear-gradient(90deg,#2244ff,#44aaff); transition:width 0.2s; }

/* Stats */
#stats {
  position:absolute; top:90px; left:20px;
  color:#00ff88; font-size:12px; letter-spacing:2px;
  text-shadow:0 0 6px #00ff88; line-height:1.9;
}

/* Active effects */
#effects {
  position:absolute; top:20px; left:220px;
  font-size:11px; letter-spacing:2px; line-height:2;
}

/* Ammo */
#ammo-box {
  position:absolute; bottom:130px; right:40px;
  text-align:right; color:#fff; font-size:22px; letter-spacing:3px;
}
#ammo-box small { display:block; font-size:10px; color:#666; letter-spacing:4px; margin-top:3px; }

/* Weapon name */
#weapon-name {
  position:absolute; bottom:160px; right:40px;
  color:#aaa; font-size:11px; letter-spacing:4px; text-align:right;
}

/* Reload bar */
#reloadbar { position:absolute; bottom:122px; right:40px; width:130px; height:3px; background:rgba(255,255,255,0.1); display:none; }
#reloadfill { height:100%; width:0; background:#ff4040; }

/* Inventory bar */
#inventory {
  position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
  display:flex; gap:6px;
}
.inv-slot {
  width:56px; height:56px; border:1px solid rgba(255,255,255,0.15);
  background:rgba(0,0,0,0.5); display:flex; flex-direction:column;
  align-items:center; justify-content:center; position:relative;
  transition:border-color 0.15s;
}
.inv-slot.selected { border-color:#fff; box-shadow:0 0 8px rgba(255,255,255,0.4); }
.inv-slot.selected::after { content:''; position:absolute; bottom:-6px; left:50%; transform:translateX(-50%); width:4px; height:4px; background:#fff; border-radius:50%; }
.inv-slot .slot-icon { font-size:22px; line-height:1; }
.inv-slot .slot-name { font-size:7px; color:#888; letter-spacing:1px; margin-top:2px; text-align:center; }
.inv-slot .slot-num { position:absolute; top:3px; left:5px; font-size:8px; color:#555; }
.inv-slot .slot-count { position:absolute; bottom:3px; right:4px; font-size:8px; color:#aaa; }
.inv-slot.powerup { border-color:rgba(100,255,100,0.3); }
.inv-slot.weapon  { border-color:rgba(255,180,50,0.3); }
.inv-slot.potion  { border-color:rgba(100,180,255,0.3); }

/* Crosshair */
#crosshair { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:22px; height:22px; }
#crosshair::before,#crosshair::after { content:''; position:absolute; background:rgba(255,255,255,0.85); }
#crosshair::before { width:100%; height:1px; top:50%; left:0; transform:translateY(-50%); }
#crosshair::after  { height:100%; width:1px; left:50%; top:0; transform:translateX(-50%); }
#crosshair-dot { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:3px; height:3px; background:rgba(255,60,60,0.8); border-radius:50%; }

/* Scope */
#scope { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:380px; height:380px; display:none; }
#scope svg { width:100%; height:100%; }

/* Messages */
#msg {
  position:absolute; top:42%; left:50%; transform:translate(-50%,-50%);
  font-size:28px; letter-spacing:8px; font-weight:bold;
  color:#ff4040; opacity:0; transition:opacity 0.2s;
  text-shadow:0 0 20px #ff2020; white-space:nowrap;
}

/* Killfeed */
#killfeed { position:absolute; top:20px; right:20px; text-align:right; font-size:11px; letter-spacing:2px; color:#ff5555; line-height:2.2; }

/* Zoom label */
#zoom-label { position:absolute; bottom:100px; left:40px; color:#666; font-size:11px; letter-spacing:3px; }

/* Status icons (crouch/jump) */
#status-icons { position:absolute; bottom:100px; left:40px; color:#aaa; font-size:11px; letter-spacing:2px; margin-top:18px; }

/* Damage overlay */
#dmg-overlay { position:fixed; inset:0; background:rgba(255,0,0,0); pointer-events:none; z-index:40; transition:background 0.15s; }

/* Flash */
#flash { position:fixed; inset:0; background:#fff; opacity:0; pointer-events:none; z-index:50; }

/* Pickup notice */
#pickup-notice {
  position:absolute; top:36%; left:50%; transform:translate(-50%,-50%);
  font-size:14px; letter-spacing:4px; color:#ffdd44;
  opacity:0; transition:opacity 0.3s; text-shadow:0 0 10px #ffaa00;
}

/* Death screen */
#death-screen {
  position:fixed; inset:0; background:rgba(0,0,0,0.85);
  display:none; flex-direction:column; align-items:center; justify-content:center;
  z-index:300; color:#fff;
}
#death-screen h2 { font-size:52px; letter-spacing:10px; color:#ff2222; text-shadow:0 0 40px #ff0000; margin-bottom:20px; }
#death-screen p { color:#888; letter-spacing:3px; font-size:13px; margin:5px 0; }
#respawnBtn { margin-top:30px; padding:12px 40px; background:transparent; border:1px solid #ff3333; color:#ff3333; font-family:'Courier New'; font-size:14px; letter-spacing:5px; cursor:pointer; }
#respawnBtn:hover { background:#ff3333; color:#000; }

/* Controls hint */
#controls-hint {
  position:absolute; bottom:20px; right:20px;
  font-size:9px; letter-spacing:1px; color:#333; line-height:1.8; text-align:right;
}

/* Intro */
#intro { position:fixed; inset:0; background:#0a0a0a; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:200; color:#fff; }
#intro h1 { font-size:56px; letter-spacing:14px; color:#ff3333; text-shadow:0 0 40px #ff1111; margin-bottom:6px; }
#intro .sub { color:#444; letter-spacing:5px; font-size:11px; margin-bottom:28px; }
#intro table { border-collapse:collapse; margin-bottom:28px; }
#intro td { padding:5px 18px; font-size:12px; letter-spacing:1px; color:#777; }
#intro td:first-child { color:#aaa; text-align:right; }
#startBtn { padding:13px 46px; background:transparent; border:1px solid #ff3333; color:#ff3333; font-family:'Courier New'; font-size:14px; letter-spacing:6px; cursor:pointer; transition:all 0.2s; }
#startBtn:hover { background:#ff3333; color:#000; }
#lock-notice { position:fixed; bottom:16px; left:50%; transform:translateX(-50%); color:#333; font-size:10px; letter-spacing:3px; z-index:20; pointer-events:none; }
</style>
</head>
<body>

<!-- INTRO -->
<div id="intro">
  <h1>PHANTOM SHOT</h1>
  <div class="sub">TACTICAL SURVIVAL SHOOTER</div>
  <table>
    <tr><td><b>WASD</b></td><td>Moverse</td></tr>
    <tr><td><b>RatÃ³n</b></td><td>Apuntar</td></tr>
    <tr><td><b>Click Izq</b></td><td>Disparar</td></tr>
    <tr><td><b>E</b></td><td>Zoom de mira</td></tr>
    <tr><td><b>Q</b></td><td>Tirar objeto</td></tr>
    <tr><td><b>F / Enter</b></td><td>Usar objeto</td></tr>
    <tr><td><b>R</b></td><td>Recargar</td></tr>
    <tr><td><b>Espacio</b></td><td>Saltar</td></tr>
    <tr><td><b>C / Ctrl</b></td><td>Agacharse</td></tr>
    <tr><td><b>â† â†’</b></td><td>Seleccionar Ã­tem</td></tr>
  </table>
  <button id="startBtn">[ INICIAR MISIÃ“N ]</button>
</div>

<!-- HUD -->
<div id="hud">
  <div id="health-wrap">
    <div id="health-label">â¤ VIDA</div>
    <div id="health-bar"><div id="health-fill"></div></div>
    <div id="health-num">100 / 100</div>
  </div>
  <div id="armor-wrap">
    <div id="armor-label">ğŸ›¡ ARMADURA</div>
    <div id="armor-bar"><div id="armor-fill"></div></div>
  </div>
  <div id="stats">
    KILLS &nbsp;<span id="sKills">0</span><br>
    SCORE &nbsp;<span id="sScore">0</span><br>
    ACC &nbsp;&nbsp;<span id="sAcc">â€”</span>
  </div>
  <div id="effects"></div>

  <div id="scope">
    <svg viewBox="0 0 380 380">
      <defs><mask id="hole"><rect width="380" height="380" fill="white"/><circle cx="190" cy="190" r="178" fill="black"/></mask></defs>
      <rect width="380" height="380" fill="rgba(0,0,0,0.97)" mask="url(#hole)"/>
      <line x1="190" y1="12" x2="190" y2="160" stroke="#e03030" stroke-width="0.7" opacity="0.9"/>
      <line x1="190" y1="220" x2="190" y2="368" stroke="#e03030" stroke-width="0.7" opacity="0.9"/>
      <line x1="12"  y1="190" x2="160" y2="190" stroke="#e03030" stroke-width="0.7" opacity="0.9"/>
      <line x1="220" y1="190" x2="368" y2="190" stroke="#e03030" stroke-width="0.7" opacity="0.9"/>
      <circle cx="190" cy="190" r="2.5" fill="#e03030" opacity="0.9"/>
      <circle cx="190" cy="152" r="1.5" fill="#e03030" opacity="0.7"/>
      <circle cx="190" cy="228" r="1.5" fill="#e03030" opacity="0.7"/>
      <circle cx="152" cy="190" r="1.5" fill="#e03030" opacity="0.7"/>
      <circle cx="228" cy="190" r="1.5" fill="#e03030" opacity="0.7"/>
      <line x1="190" y1="114" x2="190" y2="122" stroke="#e03030" stroke-width="0.8" opacity="0.5"/>
      <line x1="190" y1="258" x2="190" y2="266" stroke="#e03030" stroke-width="0.8" opacity="0.5"/>
      <text x="198" y="120" fill="#e03030" font-size="7" font-family="Courier New" opacity="0.6">200m</text>
      <text x="198" y="270" fill="#e03030" font-size="7" font-family="Courier New" opacity="0.6">400m</text>
      <circle cx="190" cy="190" r="178" fill="none" stroke="rgba(180,160,80,0.25)" stroke-width="2"/>
      <text x="204" y="188" fill="#e03030" font-size="7" font-family="Courier New" opacity="0.45">8Ã—56</text>
    </svg>
  </div>

  <div id="crosshair"><div id="crosshair-dot"></div></div>

  <div id="weapon-name">RIFLE DE FRANCOTIRADOR</div>
  <div id="ammo-box">
    <span id="sAmmo">5</span><span style="color:#333"> | </span><span id="sRes">20</span>
    <small>MUNICIÃ“N</small>
  </div>
  <div id="reloadbar"><div id="reloadfill"></div></div>

  <div id="inventory"></div>
  <div id="msg"></div>
  <div id="pickup-notice"></div>
  <div id="killfeed"></div>
  <div id="zoom-label">ZOOM: 1Ã—</div>
  <div id="status-icons"></div>

  <div id="controls-hint">
    â† â†’ Seleccionar Ã­tem<br>
    F/Enter Usar Â· Q Tirar<br>
    Espacio Saltar Â· C Agachar<br>
    E Zoom Â· R Recargar
  </div>
</div>

<div id="dmg-overlay"></div>
<div id="flash"></div>

<div id="death-screen">
  <h2>CAÃDO EN COMBATE</h2>
  <p id="death-score"></p>
  <p id="death-kills"></p>
  <button id="respawnBtn">[ REINTENTAR ]</button>
</div>

<div id="lock-notice">Clic para capturar ratÃ³n Â· ESC para liberar</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDERER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.appendChild(renderer.domElement);
window.addEventListener('resize',()=>{
  renderer.setSize(innerWidth,innerHeight);
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCENE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x7ab0c8);
scene.fog = new THREE.FogExp2(0x8fbfcf, 0.006);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 800);
camera.position.set(0,1.7,0);
camera.rotation.order = 'YXZ';

// Lights
const sun = new THREE.DirectionalLight(0xfff0d0, 1.3);
sun.position.set(60,100,40); sun.castShadow=true;
sun.shadow.mapSize.set(2048,2048);
sun.shadow.camera.near=1; sun.shadow.camera.far=400;
sun.shadow.camera.left=sun.shadow.camera.bottom=-120;
sun.shadow.camera.right=sun.shadow.camera.top=120;
scene.add(sun);
scene.add(new THREE.AmbientLight(0x6080a0,0.7));
scene.add(new THREE.HemisphereLight(0x87ceeb,0x3a6e3a,0.5));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORLD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildWorld(){
  // Ground
  const geo = new THREE.PlaneGeometry(600,600,60,60);
  const v = geo.attributes.position;
  for(let i=0;i<v.count;i++){
    const x=v.getX(i),y=v.getY(i),d=Math.sqrt(x*x+y*y);
    if(d>8) v.setZ(i,Math.sin(x*.08)*Math.cos(y*.09)*1.2+Math.sin(x*.2)*.3);
  }
  geo.computeVertexNormals();
  const ground = new THREE.Mesh(geo, new THREE.MeshLambertMaterial({color:0x4a7a3a}));
  ground.rotation.x=-Math.PI/2; ground.receiveShadow=true; scene.add(ground);

  // Dirt patches
  for(let i=0;i<40;i++){
    const d=new THREE.Mesh(new THREE.CircleGeometry(Math.random()*5+1,7),new THREE.MeshLambertMaterial({color:0x7a5a2a}));
    d.rotation.x=-Math.PI/2; d.position.set((Math.random()-.5)*250,0.01,15+Math.random()*150); scene.add(d);
  }

  // Trees
  function addTree(x,z){
    const h=3+Math.random()*2;
    const trunk=new THREE.Mesh(new THREE.CylinderGeometry(.12,.22,h,6),new THREE.MeshLambertMaterial({color:0x5c3a1a}));
    trunk.position.set(x,h/2,z); trunk.castShadow=true; scene.add(trunk);
    const gc=[0x2a5e2a,0x316b31,0x234f23];
    for(let i=0;i<3;i++){
      const c=new THREE.Mesh(new THREE.ConeGeometry(1.6-i*.25,2.2,7),new THREE.MeshLambertMaterial({color:gc[i]}));
      c.position.set(x,h+i*1.5,z); c.castShadow=true; scene.add(c);
    }
  }
  for(let i=0;i<100;i++){const a=(i/100)*Math.PI*2,r=55+Math.random()*90;addTree(Math.cos(a)*r,Math.sin(a)*r);}
  for(let i=0;i<50;i++){const a=Math.random()*Math.PI*2,r=22+Math.random()*32;addTree(Math.cos(a)*r,Math.sin(a)*r+20);}

  // Rocks
  for(let i=0;i<35;i++){
    const r=new THREE.Mesh(new THREE.DodecahedronGeometry(Math.random()*1.8+.3,0),new THREE.MeshLambertMaterial({color:0x888090}));
    r.position.set((Math.random()-.5)*100,.3,8+Math.random()*80);
    r.rotation.set(Math.random()*3,Math.random()*3,Math.random()*3);
    r.castShadow=true; r.receiveShadow=true; scene.add(r);
  }

  // Buildings
  function box(w,h,d,col,x,z){
    const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshLambertMaterial({color:col}));
    m.position.set(x,h/2,z); m.castShadow=true; m.receiveShadow=true; scene.add(m);
  }
  box(8,5,8,0xd0a870,22,28); box(12,3,6,0xc09060,-24,40);
  box(6,8,6,0xb88858,4,55);  box(10,4,10,0xc8a070,-10,18);
  box(5,3,5,0xb8906a,35,45); box(14,2,8,0xc0a060,-35,25);
}
buildWorld();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ITEM DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ITEM_DEFS = {
  // WEAPONS
  sniper:   { name:'Francotirador', icon:'ğŸ¯', type:'weapon', ammo:5,  maxAmmo:5,  reserve:20, damage:3, zoomFov:14, zoomSens:0.0006, color:0x888888, desc:'Alta precisiÃ³n' },
  rifle:    { name:'Rifle Asalto',  icon:'ğŸ”«', type:'weapon', ammo:25, maxAmmo:25, reserve:90, damage:1, zoomFov:45, zoomSens:0.0012, color:0x555544, desc:'Disparo rÃ¡pido' },
  shotgun:  { name:'Escopeta',      icon:'ğŸ’¥', type:'weapon', ammo:8,  maxAmmo:8,  reserve:32, damage:2, zoomFov:60, zoomSens:0.0015, color:0x8b6040, desc:'DaÃ±o cercano' },
  pistol:   { name:'Pistola',       icon:'ğŸ”§', type:'weapon', ammo:12, maxAmmo:12, reserve:48, damage:1, zoomFov:65, zoomSens:0.0015, color:0x606060, desc:'Silenciosa' },

  // POTIONS
  medkit:   { name:'BotiquÃ­n',    icon:'â¤ï¸',  type:'potion', color:0xff3333, effect:'heal',   value:40,  desc:'+40 HP' },
  bigHeal:  { name:'Mega Cura',   icon:'ğŸ’Š',  type:'potion', color:0xff6666, effect:'heal',   value:100, desc:'+100 HP' },
  armor:    { name:'Chaleco',     icon:'ğŸ›¡ï¸', type:'potion', color:0x4488ff, effect:'armor',  value:50,  desc:'+50 Armadura' },

  // POWERUPS (auto-activate on pickup)
  speed:    { name:'Velocidad',   icon:'âš¡',  type:'powerup', color:0xffff00, effect:'speed',    duration:15, desc:'Velocidad x2' },
  invis:    { name:'Invisibilidad',icon:'ğŸ‘»', type:'powerup', color:0xaaaaff, effect:'invis',    duration:10, desc:'Enemigos ciegos' },
  regen:    { name:'RegeneraciÃ³n',icon:'ğŸ’š',  type:'powerup', color:0x00ff88, effect:'regen',    duration:20, desc:'+2HP/s por 20s' },
  ammopack: { name:'MuniciÃ³n',    icon:'ğŸ“¦',  type:'powerup', color:0xffaa00, effect:'ammopack', duration:0,  desc:'Recarga municiÃ³n' },
  doubleXP: { name:'Doble Puntos',icon:'â­',  type:'powerup', color:0xffdd00, effect:'doubleXP', duration:15, desc:'Puntos x2' },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const G = {
  running:false, pointerLocked:false,
  yaw:0, pitch:0,
  keys:{},

  // Player
  hp:100, maxHp:100,
  armor:0, maxArmor:100,
  velY:0, onGround:true,
  crouching:false, eyeHeight:1.7, crouchHeight:0.9,
  targetEyeHeight:1.7,
  invincible:false,

  // Weapon / ammo
  currentWeapon:'sniper',
  ammo:5, maxAmmo:5, reserve:20,
  reloading:false,
  reloadSpeed:2000,

  // View
  zoomed:false, fovTarget:75,
  breathT:0,

  // Stats
  shots:0, hits:0, kills:0, score:0,

  // Inventory: 9 slots, each {id, count} or null
  inventory: Array(9).fill(null),
  selectedSlot:0,

  // Active effects
  effects:{}, // key -> {timeLeft, value}

  // World items
  worldItems:[],
  enemies:[], particles:[],

  // Jump
  jumping:false,
};

// Start with sniper in slot 0
G.inventory[0] = { id:'sniper', count:1 };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVENTORY HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildInventoryHUD(){
  const inv = document.getElementById('inventory');
  inv.innerHTML='';
  for(let i=0;i<9;i++){
    const slot = document.createElement('div');
    slot.className='inv-slot';
    slot.id=`slot-${i}`;
    slot.innerHTML=`<div class="slot-num">${i+1}</div><div class="slot-icon"></div><div class="slot-name"></div><div class="slot-count"></div>`;
    inv.appendChild(slot);
  }
  updateInventoryHUD();
}

function updateInventoryHUD(){
  for(let i=0;i<9;i++){
    const slot = document.getElementById(`slot-${i}`);
    const item = G.inventory[i];
    slot.className='inv-slot'+(i===G.selectedSlot?' selected':'');
    if(item){
      const def = ITEM_DEFS[item.id];
      slot.classList.add(def.type);
      slot.querySelector('.slot-icon').textContent=def.icon;
      slot.querySelector('.slot-name').textContent=def.name.substring(0,8);
      slot.querySelector('.slot-count').textContent=def.type==='weapon'?`${G.ammo}/${G.reserve}`:item.count>1?`x${item.count}`:'';
    } else {
      slot.querySelector('.slot-icon').textContent='';
      slot.querySelector('.slot-name').textContent='';
      slot.querySelector('.slot-count').textContent='';
    }
  }
}

function selectSlot(i){
  const prev = G.selectedSlot;
  G.selectedSlot = Math.max(0, Math.min(8, i));
  const item = G.inventory[G.selectedSlot];
  if(item && ITEM_DEFS[item.id].type==='weapon'){
    equipWeapon(item.id);
  } else if(!item || ITEM_DEFS[item.id].type!=='weapon'){
    // keep current weapon equipped, just show slot
  }
  updateInventoryHUD();
}

function equipWeapon(id){
  const def = ITEM_DEFS[id];
  G.currentWeapon = id;
  G.ammo = def.ammo; G.maxAmmo = def.maxAmmo; G.reserve = def.reserve;
  G.reloading = false;
  document.getElementById('weapon-name').textContent = def.name.toUpperCase();
  hudAmmo();
}

function addToInventory(id){
  const def = ITEM_DEFS[id];
  // If weapon, check if already have it
  if(def.type==='weapon'){
    for(let i=0;i<9;i++){
      if(G.inventory[i] && G.inventory[i].id===id){
        // add ammo instead
        G.reserve += def.reserve;
        updateInventoryHUD(); return true;
      }
    }
  } else {
    // Stack potions
    for(let i=0;i<9;i++){
      if(G.inventory[i] && G.inventory[i].id===id){
        G.inventory[i].count++;
        updateInventoryHUD(); return true;
      }
    }
  }
  // Empty slot
  for(let i=0;i<9;i++){
    if(!G.inventory[i]){
      G.inventory[i]={ id, count:1 };
      updateInventoryHUD(); return true;
    }
  }
  return false; // full
}

function useSelectedItem(){
  const item = G.inventory[G.selectedSlot];
  if(!item) return;
  const def = ITEM_DEFS[item.id];
  if(def.type==='weapon'){ equipWeapon(item.id); showMsg('âš” '+def.name.toUpperCase(),'#ffaa44',700); return; }
  if(def.type==='potion'){ applyEffect(def); item.count--; if(item.count<=0) G.inventory[G.selectedSlot]=null; updateInventoryHUD(); return; }
}

function dropSelectedItem(){
  const item = G.inventory[G.selectedSlot];
  if(!item) return;
  const def = ITEM_DEFS[item.id];
  if(def.type==='weapon' && G.currentWeapon===item.id){ showMsg('NO PUEDES TIRAR EL ARMA ACTIVA','#ff4444',800); return; }
  // Spawn in world
  const pos = new THREE.Vector3(
    camera.position.x + Math.sin(G.yaw)*2,
    0.5,
    camera.position.z - Math.cos(G.yaw)*2
  );
  spawnWorldItem(item.id, pos);
  item.count--;
  if(item.count<=0) G.inventory[G.selectedSlot]=null;
  updateInventoryHUD();
  showMsg('TIRADO: '+def.icon,'#aaaaaa',600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EFFECTS SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyEffect(def){
  showPickup(def.icon+' '+def.name.toUpperCase()+': '+def.desc);
  if(def.effect==='heal'){
    G.hp = Math.min(G.maxHp, G.hp + def.value);
    updateHealthHUD();
  } else if(def.effect==='armor'){
    G.armor = Math.min(G.maxArmor, G.armor + def.value);
    updateHealthHUD();
  } else if(def.effect==='ammopack'){
    const wdef = ITEM_DEFS[G.currentWeapon];
    G.reserve += wdef.reserve;
    hudAmmo();
  } else {
    G.effects[def.effect] = { timeLeft: def.duration };
  }
  updateEffectsHUD();
}

function updateEffects(dt){
  for(const k of Object.keys(G.effects)){
    G.effects[k].timeLeft -= dt;
    if(G.effects[k].timeLeft<=0) delete G.effects[k];
  }
  // Regen
  if(G.effects.regen){
    G.hp = Math.min(G.maxHp, G.hp + 2*dt);
    updateHealthHUD();
  }
  updateEffectsHUD();
}

function updateEffectsHUD(){
  const el = document.getElementById('effects');
  let html='';
  if(G.effects.speed)  html+=`<div style="color:#ffff44">âš¡ VELOCIDAD ${Math.ceil(G.effects.speed.timeLeft)}s</div>`;
  if(G.effects.invis)  html+=`<div style="color:#aaaaff">ğŸ‘» INVISIBLE ${Math.ceil(G.effects.invis.timeLeft)}s</div>`;
  if(G.effects.regen)  html+=`<div style="color:#00ff88">ğŸ’š REGEN ${Math.ceil(G.effects.regen.timeLeft)}s</div>`;
  if(G.effects.doubleXP) html+=`<div style="color:#ffdd00">â­ x2 PTS ${Math.ceil(G.effects.doubleXP.timeLeft)}s</div>`;
  el.innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORLD ITEMS (pickups on ground)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ITEM_SPAWN_LIST = ['medkit','bigHeal','armor','speed','invis','regen','ammopack','doubleXP','rifle','shotgun','pistol'];

function makeItemMesh(id){
  const def = ITEM_DEFS[id];
  const group = new THREE.Group();
  const geo = def.type==='weapon' ? new THREE.BoxGeometry(.5,.15,.8) :
              def.type==='powerup'? new THREE.OctahedronGeometry(.3,0) :
                                    new THREE.SphereGeometry(.25,8,8);
  const mat = new THREE.MeshLambertMaterial({ color:def.color, emissive:def.color, emissiveIntensity:.3 });
  const mesh = new THREE.Mesh(geo, mat);
  group.add(mesh);

  // Glow ring
  const ring = new THREE.Mesh(
    new THREE.TorusGeometry(.35,.04,8,16),
    new THREE.MeshBasicMaterial({ color:def.color })
  );
  ring.rotation.x = Math.PI/2;
  group.add(ring);

  return group;
}

function spawnWorldItem(id, pos){
  const def = ITEM_DEFS[id];
  const mesh = makeItemMesh(id);
  mesh.position.copy(pos);
  scene.add(mesh);
  G.worldItems.push({ id, mesh, bobT: Math.random()*Math.PI*2 });
}

function spawnRandomItems(){
  const spread = 60;
  for(let i=0;i<18;i++){
    const id = ITEM_SPAWN_LIST[Math.floor(Math.random()*ITEM_SPAWN_LIST.length)];
    const angle = Math.random()*Math.PI*2;
    const dist  = 8+Math.random()*spread;
    spawnWorldItem(id, new THREE.Vector3(Math.cos(angle)*dist, 0.4, Math.sin(angle)*dist+10));
  }
}
spawnRandomItems();

function updateWorldItems(dt){
  for(const wi of G.worldItems){
    wi.bobT += dt;
    wi.mesh.position.y = 0.4 + Math.sin(wi.bobT*1.8)*0.12;
    wi.mesh.rotation.y += dt*1.2;

    // Check pickup
    const dx = camera.position.x - wi.mesh.position.x;
    const dz = camera.position.z - wi.mesh.position.z;
    if(Math.sqrt(dx*dx+dz*dz) < 1.4){
      const def = ITEM_DEFS[wi.id];
      if(def.type==='powerup'){
        applyEffect(def);
        scene.remove(wi.mesh);
        wi.collected = true;
        // Respawn elsewhere after delay
        setTimeout(()=>spawnWorldItem(wi.id, randomFieldPos()), 20000);
      } else {
        const added = addToInventory(wi.id);
        if(added){
          showPickup(def.icon+' '+def.name.toUpperCase()+' RECOGIDO');
          scene.remove(wi.mesh);
          wi.collected = true;
          setTimeout(()=>spawnWorldItem(wi.id, randomFieldPos()), 25000);
        }
      }
    }
  }
  G.worldItems = G.worldItems.filter(w=>!w.collected);
}

function randomFieldPos(){
  const a=Math.random()*Math.PI*2, r=8+Math.random()*60;
  return new THREE.Vector3(Math.cos(a)*r, 0.4, Math.sin(a)*r+10);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENEMIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnEnemy(){
  const angle=Math.random()*Math.PI*2, dist=22+Math.random()*55;
  const x=Math.cos(angle)*dist, z=Math.sin(angle)*dist+18;

  const group = new THREE.Group();
  const torso = new THREE.Mesh(new THREE.BoxGeometry(.55,.8,.3), new THREE.MeshLambertMaterial({color:0x3d5030}));
  torso.position.y=.1; group.add(torso);
  const head = new THREE.Mesh(new THREE.SphereGeometry(.22,8,8), new THREE.MeshLambertMaterial({color:0xc8956c}));
  head.position.y=.72; head.castShadow=true; group.add(head);
  const helm = new THREE.Mesh(new THREE.SphereGeometry(.245,8,5,0,Math.PI*2,0,Math.PI*.55), new THREE.MeshLambertMaterial({color:0x263020}));
  helm.position.y=.72; group.add(helm);
  for(const s of[-1,1]){
    const leg=new THREE.Mesh(new THREE.CylinderGeometry(.1,.09,.7,6), new THREE.MeshLambertMaterial({color:0x3d5030}));
    leg.position.set(s*.16,-.45,0); group.add(leg);
  }
  group.position.set(x,.85,z); group.castShadow=true;
  scene.add(group);

  G.enemies.push({
    group, head, alive:true, hp:3,
    speed: .6+Math.random()*.6,
    bobT: Math.random()*Math.PI*2,
    attackCooldown:0,
    attackRange:2.0,
    damage:8,
  });
}
for(let i=0;i<8;i++) spawnEnemy();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HEALTH HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHealthHUD(){
  const pct = Math.max(0,G.hp/G.maxHp*100);
  document.getElementById('health-fill').style.width=pct+'%';
  document.getElementById('health-fill').style.background =
    pct>50 ? 'linear-gradient(90deg,#22cc44,#44ff66)' :
    pct>25 ? 'linear-gradient(90deg,#ff8800,#ffaa44)' :
             'linear-gradient(90deg,#ff2222,#ff4444)';
  document.getElementById('health-num').textContent=`${Math.ceil(G.hp)} / ${G.maxHp}`;

  const aPct = G.armor/G.maxArmor*100;
  document.getElementById('armor-fill').style.width=aPct+'%';
}

function hudAmmo(){
  document.getElementById('sAmmo').textContent=G.ammo;
  document.getElementById('sRes').textContent=G.reserve;
  updateInventoryHUD();
}
function hudStats(){
  document.getElementById('sScore').textContent=G.score;
  document.getElementById('sKills').textContent=G.kills;
  document.getElementById('sAcc').textContent=G.shots>0?Math.round(G.hits/G.shots*100)+'%':'â€”';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showMsg(txt,col,dur){
  const el=document.getElementById('msg');
  el.textContent=txt; el.style.color=col; el.style.opacity='1';
  clearTimeout(el._t); el._t=setTimeout(()=>el.style.opacity='0',dur);
}
function showPickup(txt){
  const el=document.getElementById('pickup-notice');
  el.textContent=txt; el.style.opacity='1';
  clearTimeout(el._pt); el._pt=setTimeout(()=>el.style.opacity='0',2000);
}
function killfeed(){
  const msgs=['ELIMINADO','NEUTRALIZADO','DOWN','OBJETIVO CAÃDO','SEÃ‘ALADO'];
  const kf=document.getElementById('killfeed');
  const d=document.createElement('div');
  d.textContent='â–¸ '+msgs[Math.floor(Math.random()*msgs.length)];
  kf.appendChild(d); setTimeout(()=>d.remove(),2800);
}
function flashScreen(){
  const f=document.getElementById('flash');
  f.style.opacity='0.3'; f.style.transition='opacity 0.05s';
  setTimeout(()=>{ f.style.transition='opacity 0.1s'; f.style.opacity='0'; },60);
}
function damageFlash(){
  const o=document.getElementById('dmg-overlay');
  o.style.background='rgba(255,0,0,0.35)';
  setTimeout(()=>o.style.background='rgba(255,0,0,0)',300);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMBAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const raycaster = new THREE.Raycaster();

function shoot(){
  if(G.reloading) return;
  if(G.ammo<=0){ reload(); return; }

  const wdef = ITEM_DEFS[G.currentWeapon];
  G.ammo--; G.shots++;
  hudAmmo(); flashScreen();
  G.pitch -= G.zoomed ? 0.002 : 0.014;

  raycaster.setFromCamera(new THREE.Vector2(0,0), camera);

  // Shotgun hits multiple times
  const pellets = G.currentWeapon==='shotgun' ? 6 : 1;
  let gotHit=false;
  for(let p=0;p<pellets;p++){
    const spread = G.currentWeapon==='shotgun' ? 0.08 : 0;
    const dir = raycaster.ray.direction.clone();
    dir.x += (Math.random()-.5)*spread;
    dir.y += (Math.random()-.5)*spread;
    dir.normalize();
    const ray = new THREE.Raycaster(camera.position.clone(), dir);

    for(const e of G.enemies){
      if(!e.alive) continue;
      const hits=ray.intersectObjects(e.group.children,true);
      if(hits.length>0){
        gotHit=true; G.hits++;
        const hs=hits[0].object===e.head;
        const dmg = hs ? wdef.damage*3 : wdef.damage;
        e.hp -= dmg;
        if(e.hp<=0) killEnemy(e,hs);
        else showMsg('Â· HIT Â·','#ffffff',300);
        break;
      }
    }
  }
  hudStats();
  if(G.ammo===0) setTimeout(reload,300);
}

function killEnemy(e,hs){
  e.alive=false;
  e.group.rotation.z=Math.PI/2;
  e.group.position.y=.2;
  spawnBlood(e.group.position.clone().add(new THREE.Vector3(0,.8,0)));
  G.kills++;
  const pts = (hs?250:100) * (G.effects.doubleXP?2:1);
  G.score+=pts;
  showMsg(hs?'âœ¦ HEADSHOT âœ¦':'âœ¦ KILL âœ¦','#ff3030',900);
  killfeed(); hudStats();
  // Sometimes drop item
  if(Math.random()<0.4){
    const drops=['medkit','ammopack','armor'];
    spawnWorldItem(drops[Math.floor(Math.random()*drops.length)], e.group.position.clone().add(new THREE.Vector3(0,.5,0)));
  }
  setTimeout(()=>{
    scene.remove(e.group);
    const i=G.enemies.indexOf(e); if(i>-1) G.enemies.splice(i,1);
    spawnEnemy();
  },2500);
}

function takeDamage(dmg){
  if(G.invincible) return;
  // Armor absorbs 60%
  let remaining = dmg;
  if(G.armor>0){
    const absorbed = Math.min(G.armor, dmg*.6);
    G.armor -= absorbed;
    remaining -= absorbed;
  }
  G.hp -= remaining;
  updateHealthHUD();
  damageFlash();
  if(G.hp<=0){ G.hp=0; updateHealthHUD(); die(); }
}

function die(){
  G.running=false;
  document.getElementById('death-score').textContent='PUNTUACIÃ“N: '+G.score;
  document.getElementById('death-kills').textContent='BAJAS: '+G.kills;
  document.getElementById('death-screen').style.display='flex';
  if(document.pointerLockElement) document.exitPointerLock();
}

function respawn(){
  G.hp=100; G.armor=0;
  G.kills=0; G.score=0; G.shots=0; G.hits=0;
  G.effects={};
  G.inventory=Array(9).fill(null);
  G.inventory[0]={id:'sniper',count:1};
  G.currentWeapon='sniper';
  G.ammo=5; G.maxAmmo=5; G.reserve=20; G.reloading=false;
  G.yaw=0; G.pitch=0;
  G.selectedSlot=0;
  camera.position.set(0,1.7,0);
  document.getElementById('death-screen').style.display='none';
  updateHealthHUD(); hudAmmo(); hudStats();
  buildInventoryHUD();
  updateEffectsHUD();
  // Clear and respawn enemies
  for(const e of G.enemies) scene.remove(e.group);
  G.enemies=[];
  for(let i=0;i<8;i++) spawnEnemy();
  G.running=true;
  renderer.domElement.requestPointerLock();
}

function reload(){
  if(G.reloading||G.reserve<=0||G.ammo===G.maxAmmo) return;
  G.reloading=true;
  const bar=document.getElementById('reloadbar');
  const fill=document.getElementById('reloadfill');
  bar.style.display='block';
  fill.style.transition='none'; fill.style.width='0';
  const wdef = ITEM_DEFS[G.currentWeapon];
  const rTime = G.currentWeapon==='sniper'?2200:G.currentWeapon==='shotgun'?2500:1400;
  requestAnimationFrame(()=>{
    fill.style.transition=`width ${rTime}ms linear`; fill.style.width='100%';
  });
  setTimeout(()=>{
    const take=Math.min(G.maxAmmo-G.ammo,G.reserve);
    G.ammo+=take; G.reserve-=take;
    G.reloading=false; bar.style.display='none'; hudAmmo();
  },rTime);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ZOOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleZoom(){
  const wdef = ITEM_DEFS[G.currentWeapon];
  G.zoomed = !G.zoomed;
  G.fovTarget = G.zoomed ? wdef.zoomFov : 75;
  document.getElementById('scope').style.display    = G.zoomed?'block':'none';
  document.getElementById('crosshair').style.display= G.zoomed?'none':'block';
  document.getElementById('zoom-label').textContent = G.zoomed?'ZOOM: '+Math.round(75/wdef.zoomFov)+'Ã—':'ZOOM: 1Ã—';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnBlood(pos){
  for(let i=0;i<10;i++){
    const p=new THREE.Mesh(new THREE.SphereGeometry(.04,4,4), new THREE.MeshBasicMaterial({color:0xbb0000,transparent:true}));
    p.position.copy(pos).add(new THREE.Vector3((Math.random()-.5)*.4,Math.random()*.4,(Math.random()-.5)*.4));
    p.userData.vel=new THREE.Vector3((Math.random()-.5)*3,Math.random()*5+1,(Math.random()-.5)*3);
    p.userData.life=1.0; scene.add(p); G.particles.push(p);
  }
}
function updateParticles(dt){
  for(let i=G.particles.length-1;i>=0;i--){
    const p=G.particles[i];
    p.userData.vel.y-=12*dt;
    p.position.addScaledVector(p.userData.vel,dt);
    p.userData.life-=dt*1.8;
    p.material.opacity=Math.max(0,p.userData.life);
    if(p.userData.life<=0){scene.remove(p);G.particles.splice(i,1);}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if(!G.running) return;
  G.keys[e.code]=true;
  switch(e.code){
    case 'KeyR': reload(); break;
    case 'KeyE': toggleZoom(); break;
    case 'KeyQ': dropSelectedItem(); break;
    case 'KeyF': case 'Enter': useSelectedItem(); break;
    case 'Space':
      if(G.onGround&&!G.crouching){ G.velY=6; G.onGround=false; G.jumping=true; }
      e.preventDefault(); break;
    case 'KeyC': case 'ControlLeft': case 'ControlRight':
      G.crouching=!G.crouching;
      G.targetEyeHeight=G.crouching?G.crouchHeight:G.eyeHeight;
      document.getElementById('status-icons').textContent=G.crouching?'[AGACHADO]':'';
      break;
    case 'ArrowLeft':
      selectSlot((G.selectedSlot+8)%9); break;
    case 'ArrowRight':
      selectSlot((G.selectedSlot+1)%9); break;
    // Number keys 1-9
    case 'Digit1': selectSlot(0); break;
    case 'Digit2': selectSlot(1); break;
    case 'Digit3': selectSlot(2); break;
    case 'Digit4': selectSlot(3); break;
    case 'Digit5': selectSlot(4); break;
    case 'Digit6': selectSlot(5); break;
    case 'Digit7': selectSlot(6); break;
    case 'Digit8': selectSlot(7); break;
    case 'Digit9': selectSlot(8); break;
  }
});
document.addEventListener('keyup',e=>{ G.keys[e.code]=false; });
document.addEventListener('contextmenu',e=>e.preventDefault());

document.addEventListener('mousemove',e=>{
  if(!G.pointerLocked||!G.running) return;
  const wdef=ITEM_DEFS[G.currentWeapon];
  const s=G.zoomed?wdef.zoomSens:0.0018;
  G.yaw  -=e.movementX*s;
  G.pitch-=e.movementY*s;
  G.pitch=Math.max(-1.2,Math.min(1.2,G.pitch));
});

document.addEventListener('mousedown',e=>{
  if(!G.running) return;
  if(!G.pointerLocked){ renderer.domElement.requestPointerLock(); return; }
  if(e.button===0) shoot();
});

document.addEventListener('pointerlockchange',()=>{
  G.pointerLocked=document.pointerLockElement===renderer.domElement;
  document.getElementById('lock-notice').style.opacity=G.pointerLocked?'0':'1';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const clock=new THREE.Clock();

function loop(){
  requestAnimationFrame(loop);
  const dt=Math.min(clock.getDelta(),.05);

  // FOV lerp
  camera.fov+=(G.fovTarget-camera.fov)*.15;
  camera.updateProjectionMatrix();

  if(!G.running){ renderer.render(scene,camera); return; }

  updateEffects(dt);

  // â”€â”€ MOVEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const crouchMult = G.crouching ? 0.5 : 1;
  const speedMult  = G.effects.speed ? 2 : 1;
  const speed = (G.zoomed?1.5:5.5) * crouchMult * speedMult;

  const sinY=Math.sin(G.yaw), cosY=Math.cos(G.yaw);
  let mx=0, mz=0;
  if(G.keys['KeyW']){mx-=sinY;mz-=cosY;}
  if(G.keys['KeyS']){mx+=sinY;mz+=cosY;}
  if(G.keys['KeyA']){mx-=cosY;mz+=sinY;}
  if(G.keys['KeyD']){mx+=cosY;mz-=sinY;}
  const len=Math.sqrt(mx*mx+mz*mz);
  if(len>0){
    camera.position.x+=(mx/len)*speed*dt;
    camera.position.z+=(mz/len)*speed*dt;
  }
  camera.position.x=Math.max(-100,Math.min(100,camera.position.x));
  camera.position.z=Math.max(-100,Math.min(100,camera.position.z));

  // â”€â”€ JUMP / GRAVITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  G.velY -= 18*dt;
  camera.position.y += G.velY*dt;
  const targetY = G.crouching ? G.crouchHeight : G.eyeHeight;
  if(camera.position.y <= targetY){
    camera.position.y = targetY;
    G.velY = 0;
    G.onGround = true;
    G.jumping = false;
  }

  camera.rotation.y=G.yaw;
  camera.rotation.x=G.pitch;

  // â”€â”€ BREATH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(G.zoomed){
    G.breathT+=dt;
    G.pitch+=Math.sin(G.breathT*.7)*.00015;
    G.yaw  +=Math.sin(G.breathT*.5)*.00008;
  }

  // â”€â”€ ENEMIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  for(const e of G.enemies){
    if(!e.alive) continue;

    const dx=camera.position.x-e.group.position.x;
    const dz=camera.position.z-e.group.position.z;
    const dist=Math.sqrt(dx*dx+dz*dz);

    // Move towards player (unless invisible)
    if(!G.effects.invis && dist>e.attackRange){
      e.group.position.x+=(dx/dist)*e.speed*dt;
      e.group.position.z+=(dz/dist)*e.speed*dt;
    }
    e.group.lookAt(camera.position.x,e.group.position.y,camera.position.z);
    e.bobT+=dt;
    e.group.position.y=.85+Math.sin(e.bobT*5)*.04;

    // Attack player
    if(dist<e.attackRange+.5 && !G.effects.invis){
      e.attackCooldown-=dt;
      if(e.attackCooldown<=0){
        takeDamage(e.damage);
        e.attackCooldown=1.5;
      }
    }
  }

  // â”€â”€ WORLD ITEMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  updateWorldItems(dt);

  // â”€â”€ PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  updateParticles(dt);

  renderer.render(scene,camera);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('startBtn').addEventListener('click',()=>{
  document.getElementById('intro').style.display='none';
  G.running=true;
  renderer.domElement.requestPointerLock();
  buildInventoryHUD();
  updateHealthHUD(); hudAmmo(); hudStats();
});

document.getElementById('respawnBtn').addEventListener('click', respawn);

loop();
</script>
</body>
</html>
